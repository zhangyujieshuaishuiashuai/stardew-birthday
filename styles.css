/* --- 1. 全局变量 --- */
:root {
    --font-main: 'MyPixelFont', sans-serif;
    --color-wood-dark: #5e3a1d;
    --color-wood-light: #e0cda8;
    --color-cream: #fffbf0;
    --color-green: #7c9c64;
    --color-blue: #62a1d8;
    --color-orange: #ffae00;
    --color-speaker-bg: #d35400; 

    /* --- 移动端适配（关键） --- */
    /* iPhone 刘海/底部安全区 */
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    /* JS 会写入 --vh 解决移动端 100vh 抖动；没有 JS 时回退到 1vh */
    --vh: 1vh;
    /* 关键区域高度自适应，避免不同机型遮挡 */
    --header-h: clamp(52px, 8vh, 76px);
    --dialogue-h: clamp(112px, 20vh, 176px);
}

@font-face { font-family: 'MyPixelFont'; src: url('font.ttf'); }

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
    font-family: var(--font-main);
    background-color: var(--color-blue);
    color: var(--color-wood-dark);
    /* 关键：移动端地址栏/工具栏会导致 100vh 误差；用 --vh 修正 */
    height: calc(var(--vh) * 100);
    min-height: 100dvh;
    overflow: hidden;
    position: relative;
}

.hidden { display: none !important; }

/* --- 2. 背景（增强：更“星露谷”像素风、更温馨） --- */
.bg-wrapper{
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; pointer-events: none; overflow: hidden;
}

/* 统一的柔光与像素纹理叠层（不影响前景 UI） */
.bg-wrapper::before{
    content:""; position:absolute; inset:0;
    background:
        radial-gradient(circle at 75% 18%, rgba(255, 211, 106, 0.28), transparent 40%),
        radial-gradient(circle at 25% 28%, rgba(255, 245, 215, 0.18), transparent 45%),
        linear-gradient(to bottom, rgba(255,255,255,0.10), rgba(0,0,0,0.06));
    opacity: 1;
    z-index: 3;
}
.bg-wrapper::after{
    /* 像素颗粒感（CSS dithering），让背景不那么“平” */
    content:""; position:absolute; inset:0;
    background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,0.05) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.04) 0 1px, transparent 1px 4px);
    opacity: 0.22;
    mix-blend-mode: overlay;
    z-index: 4;
}

.sky{
    height: 58%;
    background: linear-gradient(to bottom, #5fa4de 0%, #9ed9ff 55%, #c7f0ff 100%);
}

/* 云层贴图（大块像素云） */
.clouds-bg{
    position:absolute; top:0; left:0; width:100%; height:58%;
    background-image: url("data:image/svg+xml;utf8,%3Csvg%20xmlns%3D'http://www.w3.org/2000/svg'%20width%3D'280'%20height%3D'140'%20viewBox%3D'0%200%20280%20140'%3E%0A%3Crect%20width%3D'280'%20height%3D'140'%20fill%3D'none'/%3E%0A%3Cg%20opacity%3D'0.95'%3E%0A%20%20%3C%21--%20cloud%201%20--%3E%0A%20%20%3Crect%20x%3D'18'%20y%3D'34'%20width%3D'22'%20height%3D'12'%20fill%3D'%23ffffff'/%3E%0A%20%20%3Crect%20x%3D'40'%20y%3D'28'%20width%3D'34'%20height%3D'18'%20fill%3D'%23ffffff'/%3E%0A%20%20%3Crect%20x%3D'74'%20y%3D'34'%20width%3D'44'%20height%3D'12'%20fill%3D'%23ffffff'/%3E%0A%20%20%3Crect%20x%3D'118'%20y%3D'38'%20width%3D'22'%20height%3D'10'%20fill%3D'%23ffffff'/%3E%0A%20%20%3C%21--%20cloud%202%20--%3E%0A%20%20%3Crect%20x%3D'156'%20y%3D'58'%20width%3D'20'%20height%3D'12'%20fill%3D'%23ffffff'/%3E%0A%20%20%3Crect%20x%3D'176'%20y%3D'52'%20width%3D'30'%20height%3D'18'%20fill%3D'%23ffffff'/%3E%0A%20%20%3Crect%20x%3D'206'%20y%3D'58'%20width%3D'40'%20height%3D'12'%20fill%3D'%23ffffff'/%3E%0A%20%20%3Crect%20x%3D'246'%20y%3D'62'%20width%3D'18'%20height%3D'10'%20fill%3D'%23ffffff'/%3E%0A%20%20%3C%21--%20tiny%20puffs%20--%3E%0A%20%20%3Crect%20x%3D'92'%20y%3D'18'%20width%3D'14'%20height%3D'8'%20fill%3D'%23ffffff'/%3E%0A%20%20%3Crect%20x%3D'106'%20y%3D'14'%20width%3D'18'%20height%3D'12'%20fill%3D'%23ffffff'/%3E%0A%20%20%3Crect%20x%3D'124'%20y%3D'18'%20width%3D'22'%20height%3D'8'%20fill%3D'%23ffffff'/%3E%0A%3C/g%3E%0A%3C/svg%3E");
    background-size: 280px 140px;
    background-repeat: repeat;
    opacity: 0.35;
    image-rendering: pixelated;
    animation: clouds-drift 90s linear infinite;
    z-index: 1;
}
@keyframes clouds-drift{
    from{ transform: translateX(0); }
    to{ transform: translateX(-280px); }
}

/* 太阳（像素风+暖色光晕） */
.sun{
    position: fixed;
    top: calc(var(--safe-top) + 14px);
    right: clamp(18px, 4vw, 36px);
    width: clamp(54px, 10vw, 88px);
    height: clamp(54px, 10vw, 88px);
    border: 4px solid var(--color-wood-dark);
    border-radius: 10px;
    background:
        radial-gradient(circle at 30% 30%, #fff7d6 0 18%, #ffd36a 18% 60%, #ffb300 60% 100%);
    box-shadow: inset -4px -4px 0 rgba(0,0,0,0.12), 4px 4px 0 rgba(0,0,0,0.18);
    filter: drop-shadow(0 0 18px rgba(255, 211, 106, 0.35));
    z-index: 2;
}

/* 飞鸟（小点缀，增加“生活气”） */
.birds{
    position: fixed;
    top: calc(var(--safe-top) + 72px);
    left: -160px;
    width: 140px; height: 60px;
    background-image: url("data:image/svg+xml;utf8,%3Csvg%20xmlns%3D'http://www.w3.org/2000/svg'%20width%3D'140'%20height%3D'60'%20viewBox%3D'0%200%20140%2060'%3E%0A%3Cpath%20d%3D'M10%2034c10-10%2018-10%2028%200'%20fill%3D'none'%20stroke%3D'%23331d0f'%20stroke-width%3D'4'%20stroke-linecap%3D'round'/%3E%0A%3Cpath%20d%3D'M38%2034c10-10%2018-10%2028%200'%20fill%3D'none'%20stroke%3D'%23331d0f'%20stroke-width%3D'4'%20stroke-linecap%3D'round'/%3E%0A%3Cpath%20d%3D'M82%2022c10-10%2018-10%2028%200'%20fill%3D'none'%20stroke%3D'%23331d0f'%20stroke-width%3D'4'%20stroke-linecap%3D'round'/%3E%0A%3Cpath%20d%3D'M110%2022c10-10%2018-10%2028%200'%20fill%3D'none'%20stroke%3D'%23331d0f'%20stroke-width%3D'4'%20stroke-linecap%3D'round'/%3E%0A%3C/svg%3E");
    background-size: 140px 60px;
    background-repeat: no-repeat;
    opacity: 0.55;
    image-rendering: pixelated;
    animation: birds-fly 55s linear infinite;
    z-index: 2;
}
@keyframes birds-fly{
    from{ transform: translateX(0); }
    to{ transform: translateX(calc(100vw + 320px)); }
}

/* 海面层：把天空/山/草地分出层次 */
.water{
    height: 12%;
    background: linear-gradient(to bottom, #5bb7ea 0%, #3a93d3 70%, #2c7fbe 100%);
    border-top: 4px solid rgba(94,58,29,0.55);
    box-shadow: inset 0 10px 0 rgba(255,255,255,0.12);
    margin-top: -2%;
}

/* 山（前景层） */
.mountain{
    position: relative;
    height: 18%;
    background: linear-gradient(to bottom, #4f9b3e 0%, #3c7f32 100%);
    clip-path: polygon(0% 100%, 18% 14%, 38% 100%, 58% 24%, 78% 100%, 100% 34%, 100% 100%);
    margin-top: -6%;
    z-index: 0;
}
.mountain::before{
    /* 远景山（更淡一层） */
    content:""; position:absolute; left:-5%; right:-5%; top:-22%; bottom:-8%;
    background: rgba(60, 127, 50, 0.45);
    clip-path: polygon(0% 100%, 12% 22%, 30% 100%, 52% 30%, 74% 100%, 100% 40%, 100% 100%);
    transform: translateY(10%);
}

/* 草地层：加“草纹理+小花点缀”，更温馨 */
.ground{
    position: relative;
    height: 42%;
    background:
        linear-gradient(to bottom, #85b96a 0%, #6fae5b 55%, #5a9a4d 100%),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.10) 0 2px, transparent 2px 7px),
        repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0 2px, transparent 2px 5px),
        radial-gradient(circle at 15% 38%, rgba(255,255,255,0.55) 0 2px, transparent 3px),
        radial-gradient(circle at 38% 58%, rgba(255,210,230,0.58) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 34%, rgba(255,255,220,0.58) 0 2px, transparent 3px),
        radial-gradient(circle at 84% 52%, rgba(255,230,150,0.58) 0 2px, transparent 3px);
    background-size: auto, 14px 100%, 100% 16px, 140px 90px, 160px 110px, 180px 120px, 200px 130px;
    background-repeat: repeat;
    border-top: 4px solid var(--color-wood-dark);
    z-index: 0;
}

/* 萤火虫：低频、柔和，不喧宾夺主 */
.fireflies{
    position:absolute; inset:0;
    z-index: 5;
    pointer-events:none;
}
.fireflies span{
    position:absolute;
    width: 6px; height: 6px;
    background: #fff3a0;
    border: 2px solid rgba(94,58,29,0.45);
    border-radius: 2px;
    opacity: 0.0;
    image-rendering: pixelated;
    animation: firefly 6.8s ease-in-out infinite;
}
.fireflies span:nth-child(1){ left: 18%; top: 66%; animation-delay: 0.2s; }
.fireflies span:nth-child(2){ left: 28%; top: 74%; animation-delay: 1.4s; }
.fireflies span:nth-child(3){ left: 42%; top: 62%; animation-delay: 2.1s; }
.fireflies span:nth-child(4){ left: 56%; top: 70%; animation-delay: 0.9s; }
.fireflies span:nth-child(5){ left: 68%; top: 64%; animation-delay: 2.8s; }
.fireflies span:nth-child(6){ left: 78%; top: 76%; animation-delay: 1.8s; }
.fireflies span:nth-child(7){ left: 12%; top: 80%; animation-delay: 3.2s; }
.fireflies span:nth-child(8){ left: 90%; top: 68%; animation-delay: 2.4s; }
.fireflies span:nth-child(9){ left: 36%; top: 82%; animation-delay: 3.8s; }
.fireflies span:nth-child(10){ left: 62%; top: 84%; animation-delay: 4.3s; }

@keyframes firefly{
    0%   { transform: translate(0, 0) scale(0.9); opacity: 0; }
    35%  { transform: translate(6px, -10px) scale(1.0); opacity: 0.55; }
    65%  { transform: translate(-4px, -18px) scale(0.95); opacity: 0.35; }
    100% { transform: translate(0, 0) scale(0.9); opacity: 0; }
}

/* 尊重用户减少动画偏好 */
@media (prefers-reduced-motion: reduce){
    .clouds-bg, .birds, .fireflies span{ animation: none !important; }
}


/* --- 3. UI 组件 --- */
.pixel-box {
    background: var(--color-wood-light);
    border: 4px solid var(--color-wood-dark);
    box-shadow: inset -4px -4px 0 rgba(0,0,0,0.15), 4px 4px 0 rgba(0,0,0,0.2);
    border-radius: 8px; padding: 15px;
}

.pixel-btn {
    background: var(--color-cream);
    border: 3px solid var(--color-wood-dark);
    color: var(--color-wood-dark);
    padding: 8px 15px;
    font-family: inherit; font-size: 1rem; font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 0 var(--color-wood-dark);
    transition: transform 0.1s;
    position: relative; z-index: 9999; 
}
.pixel-btn:active { transform: translateY(4px); box-shadow: 0 0 0; }
.pixel-btn.confirm { background: #98fb98; }
.pixel-btn.big-btn { font-size: 1.5rem; padding: 15px 30px; }

/* 返回按钮样式 */
.back-btn {
    position: fixed;
    top: calc(var(--safe-top) + var(--header-h) + 8px);
    left: 12px;
    z-index: 500; background: #fff;
    padding: 6px 10px;
    font-size: clamp(0.75rem, 2.4vw, 0.95rem);
}

.header-bar {
    position: fixed;
    top: calc(10px + var(--safe-top));
    left: 50%;
    transform: translateX(-50%);
    width: 95%; max-width: 800px; z-index: 5000;
    display: flex; justify-content: space-between; align-items: center;
    background: var(--color-cream);
    border: 3px solid var(--color-wood-dark);
    border-radius: 8px;
    padding: clamp(8px, 2.2vw, 12px);
    box-shadow: 0 4px 0 rgba(0,0,0,0.2);
}
.header-bar h1 { font-size: clamp(0.95rem, 2.8vw, 1.2rem); margin: 0; }

.pixel-btn {
    font-size: clamp(0.9rem, 2.8vw, 1rem);
}

.pixel-btn.big-btn { font-size: clamp(1.2rem, 4.8vw, 1.5rem); padding: 15px 30px; }

/* --- 5. 故事模式 --- */
#story-view {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    /* 给顶部 header / 底部对话框留空间，避免小屏被遮住 */
    padding-top: calc(var(--safe-top) + var(--header-h) + 12px);
    padding-bottom: calc(var(--safe-bottom) + var(--dialogue-h) + 12px);
    z-index: 10;
}

#story-cover {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: calc(var(--vh) * 100);
    background: rgba(255, 255, 255, 0.95);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 200;
}
.pixel-h1 { font-size: clamp(1.4rem, 6vw, 2rem); text-align: center; margin-bottom: 30px; color: var(--color-orange); text-shadow: 2px 2px 0 var(--color-wood-dark); }

#quiz-board {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 90%; max-width: 400px; z-index: 100;
    text-align: center;
}
.board-header { 
    background: var(--color-orange); color: white; display: inline-block; 
    padding: 5px 15px; border: 3px solid var(--color-wood-dark); margin-bottom: 15px;
}
.board-content { font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px; min-height: 80px; }
#quiz-hint { color: #666; font-style: italic; margin-top: 10px; font-size: 0.9rem; }
#quiz-answer { color: #d35400; font-weight: bold; margin-top: 10px; border-top: 2px dashed #888; padding-top: 10px; }
.board-actions { display: flex; flex-direction: column; gap: 10px; }

/* === 核心修改区：图片展示 === */
#stage {
    margin-top: 0;
    flex: 1;
    min-height: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    position: relative; z-index: 50; 
}

.photo-frame {
    height: auto; width: auto;
    /* 关键：图片高度=视口高度 - header - 对话框 - 安全区 - 预留间距 */
    max-height: calc((var(--vh) * 100) - var(--safe-top) - var(--safe-bottom) - var(--header-h) - var(--dialogue-h) - 48px);
    max-width: min(88vw, 520px);
    aspect-ratio: 3/4;
    
    border: 6px solid var(--color-wood-dark); 
    background: #fff;
    padding: 8px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    border-radius: 4px; 
    overflow: hidden;
    
    opacity: 0; 
    transform: translate(-30px, 50px) rotate(-15deg) scale(0.8);
    transition: opacity 0.3s; 
}

@keyframes toss-in {
    0% { opacity: 0; transform: translate(-30px, 50px) rotate(-15deg) scale(0.8); }
    60% { opacity: 1; transform: translate(0, 0) rotate(2deg) scale(1.02); }
    100% { opacity: 1; transform: translate(0, 0) rotate(0deg) scale(1); }
}

.photo-frame.animate-enter {
    opacity: 1;
    animation: toss-in 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

.photo-frame.frame-hidden {
    opacity: 0;
    pointer-events: none;
}

.photo-frame img { width: 100%; height: 100%; object-fit: cover; display: block; }

/* 立绘样式 */
#character-sprite {
    position: fixed;
    bottom: calc(var(--safe-bottom) + var(--dialogue-h) + 8px);
    right: clamp(22px, 4vw, 48px);
    z-index: 110; 
    height: clamp(140px, 30vh, 280px);
    width: auto;
    pointer-events: none;
    background: transparent !important; 
    border: none !important;
    box-shadow: none !important;
}

#character-sprite img {
    height: 100%;
    width: auto;
    image-rendering: pixelated;
    background: transparent !important;
    display: block;
}

/* 对话框容器 */
#dialogue-wrapper {
    position: fixed;
    bottom: calc(var(--safe-bottom) + 8px);
    left: 50%;
    transform: translateX(-50%);
    width: min(95%, 600px);
    max-width: 600px;
    z-index: 100;
    display: flex;
    flex-direction: column;
}

/* 讲述者信息框 */
#speaker-box {
    background: var(--color-speaker-bg);
    color: white;
    padding: 8px 15px; 
    border: 3px solid var(--color-wood-dark);
    border-bottom: none; 
    border-radius: 10px 10px 0 0;
    width: fit-content;
    margin-bottom: -3px;
    z-index: 101;
    position: relative;
    left: 15px; 
    display: flex;
    gap: 10px;
    box-shadow: 2px -2px 0 rgba(0,0,0,0.2); 
}

#speaker-name {
    font-size: 1.1rem;
    font-weight: bold;
    text-shadow: 1px 1px 0 var(--color-wood-dark);
}

#speaker-date {
    font-size: 0.9rem;
    opacity: 0.9;
    align-self: center;
    font-weight: normal;
}

/* 对话框本身 */
#dialogue-box {
    width: 100%;
    height: var(--dialogue-h);
    background: var(--color-cream);
    display: flex;
    flex-direction: column;
    cursor: pointer;
    position: relative;
    border-top-left-radius: 0; 
    border-top: 3px solid var(--color-wood-dark);
    box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
}

#dialogue-text { font-size: clamp(0.95rem, 3.4vw, 1.1rem); line-height: 1.6; overflow-y: auto; flex: 1; font-weight: bold; padding: 10px;}
.arrow-icon { position: absolute; bottom: 10px; right: 15px; animation: bounce 1s infinite; }
@keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

/* --- 6. 画廊模式 --- */
#gallery-view {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto;
    padding-top: calc(var(--safe-top) + var(--header-h) + 16px);
    padding-bottom: calc(var(--safe-bottom) + 16px);
    z-index: 20;
    background: rgba(255,255,255,0.85);
}
.gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px; padding: 10px; max-width: 800px; margin: 0 auto;
}
.gallery-item {
    background: #fff; border: 3px solid var(--color-wood-dark);
    padding: 5px 5px 30px 5px; position: relative; cursor: pointer;
}
.gallery-item img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #ddd; }
.gallery-item p {
    position: absolute; bottom: 5px; left: 0; width: 100%;
    text-align: center; font-size: 0.8rem; font-weight: bold;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
footer { text-align: center; padding: 20px; color: #666; }

/* --- 7. 灯箱 --- */
#lightbox {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 10000;
    display: flex; justify-content: center; align-items: center;
}
.lightbox-content {
    background: var(--color-cream); width: 95%; max-width: 500px;
    padding: 10px; position: relative; display: flex; flex-direction: column;
    border: 4px solid var(--color-wood-dark);
}
.lb-media {
    width: 100%; aspect-ratio: 3/4; background: #000;
    display: flex; justify-content: center; align-items: center;
    border: 2px solid var(--color-wood-dark);
}
.lb-media img, .lb-media video { max-width: 100%; max-height: 100%; }
.lb-text { text-align: center; margin-top: 10px; }
.lb-nav { display: flex; justify-content: space-between; margin-top: 10px; }
.close-btn { 
    position: absolute; top: -15px; right: -15px; 
    background: #ff6b6b; color: white; border-radius: 50%; 
    width: 40px; height: 40px; font-size: 24px; padding: 0;
    z-index: 10001; 
}

/* --- 极小屏幕/横屏兜底 --- */
@media (max-height: 650px) {
    :root {
        --dialogue-h: clamp(80px, 22vh, 120px);
    }
    .photo-frame { border-width: 4px; padding: 6px; }
    #speaker-name { font-size: 1rem; }
    #speaker-date { font-size: 0.85rem; }
}

@media (max-width: 360px) {
    .pixel-box { padding: 12px; }
    .pixel-btn { padding: 7px 12px; }
}
